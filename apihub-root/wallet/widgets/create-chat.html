<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create Chat</title>
    <style>
        #create-chat-container {
            display: block;
            width: 500px;
            height: 350px;
        }
        #create-chat-container .modal-body{
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        #create-chat-container .create-chat{
            width: fit-content;
        }
    </style>
</head>
<body>

<div id="create-chat-container">
    <div class="modal-header">
        <div>New Chat</div>
        <div id="close-modal-btn" class="close" style="cursor: pointer;">
            <img class="close-icon" src="./wallet/assets/icons/x-mark.svg" alt="close">
        </div>
    </div>
    <form class="modal-body">
        <div class="form-item">
            <label class="form-label" for="scriptName">Select script</label>
            <select class="form-select" id="scriptName" name="scriptName" required>
                <option value="" disabled selected>Loading...</option>
            </select>
        </div>
        <div class="form-item">
            <label class="form-label" for="agent">Select Agent</label>
            <select class="form-select" id="agent" name="agent" required>
                <option value="" disabled selected>Loading...</option>
            </select>
        </div>
        <div id="create-chat-btn" class="general-button create-chat" style="cursor: pointer;">Start new chat</div>
    </form>
</div>

<script type="module">
    (async () => {
        // This script is self-contained and does not rely on a component framework.
        // It uses the global assistOS object to interact with the system.

        // Load required modules
        const chatModule = assistOS.loadModule("chat");
        const agentModule = assistOS.loadModule("agent");
        const { generateId } = await import("../../../../imports.js");

        // Get DOM elements
        const container = document.querySelector('#create-chat-container');
        if (!container) {
            console.error("Fatal error: Container #create-chat-container not found.");
            return;
        }
        const form = container.querySelector('form.modal-body');
        const scriptSelect = container.querySelector('#scriptName');
        const agentSelect = container.querySelector('#agent');
        const createChatBtn = container.querySelector('#create-chat-btn');
        const closeModalBtn = container.querySelector('#close-modal-btn');

        // Populate select options
        try {
            const scripts = await chatModule.getChatScriptNames(assistOS.space.id);
            const agents = await agentModule.getAgentNames(assistOS.space.id);

            scriptSelect.innerHTML = '<option value="" disabled selected>Select a script</option>';
            scriptSelect.insertAdjacentHTML('beforeend', scripts.map(scriptName => `<option value="${scriptName}">${scriptName}</option>`).join(''));

            agentSelect.innerHTML = '<option value="" disabled selected>Select an agent</option>';
            agentSelect.insertAdjacentHTML('beforeend', agents.map(agentName => `<option value="${agentName}">${agentName}</option>`).join(''));

        } catch (error) {
            console.error("Failed to load initial data for chat creation modal:", error);
            form.innerHTML = `<p style="color: red;">Error: Could not load required data.</p>`;
        }

        // --- Event Listeners ---

        createChatBtn.addEventListener('click', async (event) => {
            event.preventDefault();

            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            const chatId = `${data.agent}_Chat_${generateId(8)}`;
            const scriptName = data.scriptName;

            try {
                await chatModule.createChat(assistOS.space.id, chatId, scriptName, ["User", data.agent]);
                assistOS.UI.closeModal(container, chatId);
            } catch (error) {
                console.error("Failed to create chat:", error);
                alert("There was an error creating the chat. Please try again.");
            }
        });

        closeModalBtn.addEventListener('click', () => {
            assistOS.UI.closeModal(container);
        });

    })();
</script>

</body>
</html>