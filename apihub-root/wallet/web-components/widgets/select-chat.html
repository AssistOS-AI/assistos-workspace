<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Select Chat Widget</title>
</head>
<body>

<script type="module">
    (function () {
        // Load required modules using the global assistOS object
        const chatModule = assistOS.loadModule("chat", assistOS.securityContext);

        const template = document.createElement('template');
        template.innerHTML = `
            <style>
                :host {
                    display: block;
                    width: 400px;
                    font-family: sans-serif;
                }
                .chat-list-container {
                    border: 1px solid var(--border-color, #e0e0e0);
                    border-radius: 8px;
                    overflow: hidden;
                }
                .chat-list {
                    list-style: none;
                    padding: 0;
                    margin: 0;
                    max-height: 300px;
                    overflow-y: auto;
                }
                .chat-item {
                    cursor: pointer;
                    padding: 10px;
                    border-bottom: 1px solid var(--form-input-border, #e0e0e0);
                }
                .chat-item:last-child {
                    border-bottom: none;
                }
                .chat-item:hover {
                    background-color: var(--action-button-background, #f0f0f0);
                }
                .chat-item.selected {
                    background-color: var(--action-button-background, #e0e0e0);
                    cursor: default;
                }
                .placeholder {
                    padding: 10px;
                    color: #888;
                    text-align: center;
                }
            </style>
            <div class="chat-list-container">
                <ul class="chat-list">
                    <li class="placeholder">Loading chats...</li>
                </ul>
            </div>
        `;

        class SelectChat extends HTMLElement {
            constructor() {
                super();
                this.attachShadow({mode: 'open'});
                this.shadowRoot.appendChild(template.content.cloneNode(true));
                this.selectedChatId = null;
            }

            connectedCallback() {
                this.spaceId = this.getAttribute("data-space-id");
                if (!this.spaceId) {
                    console.error("data-space-id attribute is required for select-chat component.");
                    this.shadowRoot.querySelector('.chat-list').innerHTML = `<li class="placeholder" style="color: red;">Configuration error.</li>`;
                    return;
                }

                this.chatList = this.shadowRoot.querySelector('.chat-list');
                this.chatList.addEventListener('click', this.handleChatClick.bind(this));

                this.renderChats();
            }

            disconnectedCallback() {
                if(this.chatList){
                    this.chatList.removeEventListener('click', this.handleChatClick.bind(this));
                }
            }

            async renderChats() {
                try {
                    // Assuming getConversations returns an array of chat objects like [{id, name}, ...]
                    const conversations = await chatModule.getConversations(this.spaceId);
                    this.chatList.innerHTML = ''; // Clear placeholder

                    if (conversations.length === 0) {
                        this.chatList.innerHTML = `<li class="placeholder">No chats found.</li>`;
                        return;
                    }

                    conversations.forEach(chat => {
                        const chatItem = document.createElement('li');
                        chatItem.className = 'chat-item';
                        chatItem.dataset.chatId = chat.id;
                        chatItem.textContent = chat.name || chat.id;
                        this.chatList.appendChild(chatItem);
                    });

                } catch (error) {
                    console.error("Failed to load chats:", error);
                    this.chatList.innerHTML = `<li class="placeholder" style="color: red;">Failed to load chats.</li>`;
                }
            }

            handleChatClick(event) {
                const clickedItem = event.target.closest('.chat-item');
                if (!clickedItem || clickedItem.dataset.chatId === this.selectedChatId) {
                    return;
                }

                if (this.selectedChatId) {
                    const previousSelectedItem = this.shadowRoot.querySelector(`[data-chat-id="${this.selectedChatId}"]`);
                    if (previousSelectedItem) {
                        previousSelectedItem.classList.remove('selected');
                    }
                }

                clickedItem.classList.add('selected');
                this.selectedChatId = clickedItem.dataset.chatId;

                this.dispatchEvent(new CustomEvent('chat-selected', {
                    detail: { chatId: this.selectedChatId },
                    bubbles: true,
                    composed: true
                }));
            }
        }

        customElements.define('select-chat', SelectChat);
    })();
</script>

</body>
</html>